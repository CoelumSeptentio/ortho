version: "3.9"

services:
  admin:
    image: node:20
    working_dir: /app
    command: sh -lc "npm install && npx nuxt dev -H 0.0.0.0 -p 3000"
    environment:
      - STRAPI_BASE_URL=http://cms:1337
      - NUXT_PUBLIC_API_BASE=/cms
    volumes:
      - ./admin:/app
      - /app/node_modules
    depends_on:
      - cms
        
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/admin/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 20s
  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=ortho
      - POSTGRES_USER=ortho
      - POSTGRES_PASSWORD=ortho
    volumes:
      - dbdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10

  cms:
    image: node:18
    working_dir: /app
    command: sh -lc "npm install && npx strapi develop"
    environment:
      - NODE_ENV=development
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_NAME=ortho
      - DATABASE_USERNAME=ortho
      - DATABASE_PASSWORD=ortho
      - DATABASE_SSL=false
      - ADMIN_PATH=/admin
#      - STRAPI_ADMIN_BACKEND_URL=/cms
#      - STRAPI_ADMIN_URL=/cms/admin
#      - ADMIN_JWT_SECRET=/gP5gleGpOECv3vBtwFryFmPrK9O28HBp3LyQswjTmU=
      - ADMIN_URL=http://195.181.245.93:8080/cms/admin
      - PUBLIC_URL=http://195.181.245.93:8080/cms

      # (jei dar neįdėjai ankstesnių „salt“ raktų, labai rekomenduotina)
#      - APP_KEYS=key1,key2,key3,key4
#      - API_TOKEN_SALT=api_token_salt_change_me
#      - ADMIN_JWT_SECRET=admin_jwt_secret_change_me
#      - TRANSFER_TOKEN_SALT=transfer_token_salt_change_me
    env_file:
      - ./cms/.env
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:1337/admin || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 20
      start_period: 20s


    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./cms:/app
      - /app/node_modules
    # jei nori matyti iš hosto: atkomentuok
#     ports:
#       - "1337:1337"

  meili:
    image: getmeili/meilisearch:v1.10
    env_file: [ "./meili/.env" ]
    volumes:
      - meili:/meili_data

  frontend:
    user: "${UID}:${GID}"
    image: node:20
    working_dir: /app
    volumes: [ "./frontend:/app" ]
    env_file: [ ".env", "./frontend/.env" ]
    environment:
      HOST: "0.0.0.0"
      PORT: "3000"
      NITRO_HOST: "0.0.0.0"
      NITRO_PORT: "3000"
      NODE_OPTIONS: "--max-old-space-size=2048"
      CHOKIDAR_USEPOLLING: "0"
      VITE_FS_EVENTS_POLLING: "0"
    command: >
      sh -lc '
        node -e "p=require(\"./package.json\"); process.exit(p.scripts&&p.scripts.dev?0:1)" \
          && exec npx --yes pnpm@9 dev --host 0.0.0.0 --port 3000 \
          || exec npx --yes nuxi dev --host 0.0.0.0 --port 3000
      '
    depends_on: [ cms, meili ]
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/', r=>process.exit(r.statusCode<500?0:1)).on('error',()=>process.exit(1))"]
      interval: 2s
      timeout: 2s
      retries: 120
      start_period: 90s

  proxy:
    image: nginx:1.27
    depends_on:
      - cms
      - admin
      - frontend
    volumes:
      - ./reverse-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./reverse-proxy/10-wait-for-frontend.sh:/docker-entrypoint.d/10-wait-for-frontend.sh:ro
    environment:
      WAIT_URL: http://frontend:3000/
      WAIT_RETRIES: "300"
      WAIT_INTERVAL: "2"
    ports: [ "8080:80" ]

volumes:
  dbdata:
  meili:
